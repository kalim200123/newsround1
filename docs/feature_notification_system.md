# 알림 시스템 기능 명세서

> **작성일:** 2025-11-26  
> **대상:** 프론트엔드 개발자  
> **백엔드 담당:** [귀하의 이름]

---

## 1. 개요

사용자 참여를 높이기 위해 **영구적인 알림 시스템**을 구현합니다. 사용자는 전용 페이지(`/notifications`)에서 알림 기록을 확인할 수 있으며, 헤더의 종 아이콘을 통해 읽지 않은 알림 개수를 실시간으로 확인할 수 있습니다.

### 사용 사례

1. **새 토픽 발행 알림**: 새로운 토픽(ROUND2)이 발행되면 모든 사용자에게 자동 알림
2. **관리자 공지사항**: 관리자가 특정 사용자 또는 전체 사용자에게 수동으로 공지 발송
3. **향후 확장**: 친구 요청, 투표 독려, ROUND3 초대, 속보/단독 뉴스 등

---

## 2. 데이터베이스 스키마

### 2.1. `tn_notification` (신규 테이블)

알림 내역을 저장하는 메인 테이블입니다.

```sql
CREATE TABLE `tn_notification` (
  `id` BIGINT NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT '알림을 받을 사용자의 ID',
  `type` ENUM('NEW_TOPIC', 'FRIEND_REQUEST', 'VOTE_REMINDER', 'ADMIN_NOTICE') NOT NULL,
  `message` VARCHAR(255) NOT NULL COMMENT '알림 메시지 본문',
  `related_url` VARCHAR(2048) DEFAULT NULL COMMENT '알림 클릭 시 이동할 URL',
  `is_read` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '읽음 여부 (0: 안읽음, 1: 읽음)',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id_created_at` (`user_id`, `created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 2.2. `tn_user_notification_settings` (기존 테이블)

> **참고:** 이미 존재하는 테이블로, 사용자별 알림 수신 설정(ON/OFF)을 관리합니다.  
> 현재 구현 범위에는 포함되지 않지만, 추후 "알림 설정" 기능 구현 시 활용될 예정입니다.

---

## 3. API 명세

### 3.1. 사용자용 알림 API

#### 🔹 `GET /api/notifications`

사용자의 알림 목록을 최신순으로 조회합니다.

**인증:** 필수 (JWT 토큰)

**쿼리 파라미터:**
| 파라미터 | 타입 | 필수 | 기본값 | 설명 |
|---------|------|------|--------|------|
| `page` | number | 선택 | `1` | 페이지 번호 |
| `limit` | number | 선택 | `20` | 페이지당 항목 수 |

**응답 예시 (200 OK):**

```json
{
  "notifications": [
    {
      "id": 101,
      "type": "NEW_TOPIC",
      "message": "새로운 토픽 'AI vs. 인간'이 시작되었습니다. 지금 참여해보세요!",
      "related_url": "/topics/123",
      "is_read": false,
      "created_at": "2025-11-26T10:00:00Z"
    },
    {
      "id": 100,
      "type": "ADMIN_NOTICE",
      "message": "서버 점검이 예정되어 있습니다. (11/27 02:00 ~ 03:00)",
      "related_url": null,
      "is_read": true,
      "created_at": "2025-11-25T14:30:00Z"
    }
  ],
  "total": 42,
  "unread_count": 5,
  "page": 1,
  "limit": 20
}
```

---

#### 🔹 `GET /api/notifications/unread-count`

읽지 않은 알림 개수를 조회합니다. (헤더 배지용)

**인증:** 필수 (JWT 토큰)

**응답 예시 (200 OK):**

```json
{
  "unread_count": 5
}
```

---

#### 🔹 `POST /api/notifications/:id/read`

특정 알림을 읽음으로 표시합니다.

**인증:** 필수 (JWT 토큰)

**경로 파라미터:**

- `id` (number): 알림 ID

**응답 예시 (200 OK):**

```json
{
  "message": "알림을 읽음으로 표시했습니다.",
  "notification_id": 101
}
```

**오류 응답 (404 Not Found):**

```json
{
  "error": "알림을 찾을 수 없습니다."
}
```

---

#### 🔹 `POST /api/notifications/read-all`

사용자의 모든 읽지 않은 알림을 읽음으로 표시합니다.

**인증:** 필수 (JWT 토큰)

**응답 예시 (200 OK):**

```json
{
  "message": "모든 알림을 읽음으로 표시했습니다.",
  "updated_count": 5
}
```

---

### 3.2. 관리자용 알림 API

> **참고:** 관리자 UI는 백엔드 담당자가 구현합니다. 프론트엔드 개발자는 사용자용 API만 구현하면 됩니다.

#### 🔹 `POST /api/admin/notifications`

관리자가 알림을 발송합니다.

**인증:** Admin 권한 필요

**요청 본문:**

```json
{
  "user_id": 123, // 선택 사항. 생략 시 전체 사용자에게 발송
  "message": "서버 점검이 예정되어 있습니다. (11/27 02:00 ~ 03:00)",
  "related_url": "/announcements/maintenance" // 선택 사항
}
```

**응답 예시 (201 Created):**

```json
{
  "message": "알림이 성공적으로 발송되었습니다.",
  "sent_count": 1523
}
```

---

## 4. 프론트엔드 구현 가이드

### 4.1. 알림 페이지 (`/notifications`)

**경로:** `/notifications`

**구현 사항:**

1. `GET /api/notifications`를 호출하여 알림 목록 표시
2. 페이지네이션 구현 (무한 스크롤 또는 페이지 번호)
3. 읽지 않은 알림과 읽은 알림을 시각적으로 구분
   - 예: 읽지 않은 알림 배경색 강조, 글씨 굵게 등
4. 각 알림 클릭 시:
   - `POST /api/notifications/:id/read` 호출하여 읽음 처리
   - `related_url`이 있으면 해당 URL로 이동
5. "모두 읽음" 버튼: `POST /api/notifications/read-all` 호출

**UI 예시:**

```
┌─────────────────────────────────────────┐
│  알림 (5개의 읽지 않은 알림)   [모두 읽음] │
├─────────────────────────────────────────┤
│ 🔴 새로운 토픽 'AI vs. 인간'이...      │  <- 읽지 않음 (강조)
│    2시간 전                             │
├─────────────────────────────────────────┤
│    서버 점검이 예정되어 있습니다.       │  <- 읽음 (일반)
│    1일 전                               │
└─────────────────────────────────────────┘
```

---

### 4.2. 헤더/내비게이션 UI

**구현 사항:**

1. 종 아이콘(🔔) 추가
2. `GET /api/notifications/unread-count`를 주기적으로 호출 (폴링)
   - 권장: 30초~1분 간격
   - 또는 WebSocket 연결 시 실시간 업데이트
3. 읽지 않은 알림이 있으면 배지 표시 (숫자)
4. 아이콘 클릭 시 `/notifications` 페이지로 이동

**UI 예시:**

```
┌──────────────────────────────────┐
│  로고   홈   토픽   [🔔 5]   프로필 │
└──────────────────────────────────┘
         읽지 않은 알림 5개 ↑
```

---

### 4.3. 알림 타입별 메시지 예시

백엔드에서 `message`를 완성된 문장으로 보내므로, 프론트엔드에서는 그대로 표시하면 됩니다.

| `type`          | 메시지 예시                                        | `related_url` 예시 |
| --------------- | -------------------------------------------------- | ------------------ |
| `NEW_TOPIC`     | "새로운 토픽 '이재명 vs 윤석열'이 시작되었습니다!" | `/topics/123`      |
| `ADMIN_NOTICE`  | "서버 점검 안내 (11/27 02:00~03:00)"               | `/announcements/1` |
| `VOTE_REMINDER` | "투표 마감 1시간 전입니다. 참여하세요!"            | `/topics/456`      |

#### 📋 상세 메시지 샘플 (백엔드 구현 참고용)

다음은 실제로 백엔드에서 생성될 메시지 예시입니다. 프론트엔드에서 UI 개발 시 참고하세요.

**1. NEW_TOPIC (새 토픽 발행)**

```
🎯 새로운 토픽 '이재명 vs 윤석열'이(가) 시작되었습니다! 지금 참여해보세요.
🎯 새로운 토픽 'AI가 인간을 대체할까?'이(가) 시작되었습니다! 지금 참여해보세요.
🎯 새로운 토픽 '최저임금 인상 찬반'이(가) 시작되었습니다! 지금 참여해보세요.
```

**2. VOTE_REMINDER (투표 독려)**

```
⏰ '이재명 vs 윤석열' 토픽 투표 마감 1시간 전입니다. 아직 참여하지 않으셨다면 지금 투표하세요!
⏰ 'AI가 인간을 대체할까?' 토픽 투표 마감 3시간 전입니다. 아직 참여하지 않으셨다면 지금 투표하세요!
⏰ '최저임금 인상 찬반' 토픽 투표 마감 24시간 전입니다. 아직 참여하지 않으셨다면 지금 투표하세요!
```

**3. ADMIN_NOTICE (관리자 공지)**

```
📢 서버 점검이 예정되어 있습니다. (11/27 02:00 ~ 03:00)
📢 새로운 기능이 추가되었습니다! 확인해보세요.
⚠️ 긴급 공지: 일시적으로 서비스가 중단될 수 있습니다.
🎉 Different News가 출시 1주년을 맞이했습니다!
```

**4. FRIEND_REQUEST (친구 요청 - 향후 구현)**

```
👥 홍길동님이 친구 요청을 보냈습니다.
👥 김철수님이 친구 요청을 보냈습니다.
```

> **참고:**
>
> - 이모지 아이콘(🎯, ⏰, 📢 등)은 백엔드에서 메시지에 포함하여 전송합니다.
> - 프론트엔드에서는 받은 메시지를 그대로 표시하면 됩니다.
> - 실제 메시지 템플릿은 `newsround1-api/src/config/notificationTemplates.ts`에 정의되어 있습니다.

---

## 5. 백엔드 자동 알림 발송 시점

프론트엔드 개발자는 아래 이벤트 시 자동으로 알림이 생성됨을 알고 있으면 됩니다.

| 이벤트                           | 발송 대상        | `type`         |
| -------------------------------- | ---------------- | -------------- |
| 새 토픽 발행 (`status` → `OPEN`) | 전체 사용자      | `NEW_TOPIC`    |
| 관리자 공지 발송                 | 특정/전체 사용자 | `ADMIN_NOTICE` |

---

## 6. 참고 사항

1. **인증:** 모든 `/api/notifications` 엔드포인트는 JWT 인증이 필요합니다.
2. **날짜 형식:** ISO 8601 형식 (`2025-11-26T10:00:00Z`) - 로컬 타임존으로 변환하여 표시하세요.
3. **페이지네이션:** 기본 `limit=20`이며, 프론트엔드에서 조절 가능합니다.
4. **실시간 업데이트:**
   - 현재는 폴링 방식 권장 (30초~1분 간격)
   - 추후 WebSocket 활용 시 실시간 푸시 가능

---

## 7. 질문 및 협업

API 구현 후 Swagger 문서를 공유하겠습니다.  
궁금한 사항이 있으면 언제든지 연락 주세요!

**백엔드 API 베이스 URL:** `https://news01.onrender.com/api-docs`

---

**문서 버전:** 1.0  
**최종 수정:** 2025-11-26
